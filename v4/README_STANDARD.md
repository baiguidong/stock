# 上证分时图预测系统 - 标准文档

## 项目概述

本系统是一个基于历史数据模式匹配的上证指数日内分时走势预测工具。通过对当日分时数据进行特征计算,在历史数据中寻找相似模式,从而预测未来走势。

---

## 目录

1. [系统原理](#系统原理)
2. [数据说明](#数据说明)
3. [计算流程](#计算流程)
4. [安装与使用](#安装与使用)
5. [参数说明](#参数说明)
6. [输出说明](#输出说明)

---

## 系统原理

### 核心思想
基于"历史会重复"的理念,通过数值特征匹配找到历史上相似的交易日,参考其后续走势来预测未来。

### 技术特点
- 使用数字求和取余数的方法提取价格特征
- 多维度匹配历史数据(开盘、最高、最低、收盘)
- 高低点模式识别与正反向对比
- 平移算法提高匹配精度
- 涨跌震荡形态分类

---

## 数据说明

### 数据组成

本系统需要三组数据:

| 数据类型 | 说明 | 文件位置 | 格式 |
|---------|------|---------|------|
| **A. 日线数据** | 历史每日开高低收价格 | `data/日线.txt` | 日期\t开盘\t最高\t最低\t收盘 |
| **B. 分钟数据(M1)** | 当日1分钟级别分时数据 | `data/M1.txt` | 日期-时间\t开盘\t最高\t最低\t收盘 |
| **C. 历史分钟数据** | 20+年历史1分钟数据 | `data/年份.csv` | CSV格式,包含完整分时数据 |

### 数据格式示例

**日线数据 (日线.txt):**
```
2018/11/1	2602.78	2621.77	2583.46	2602.78
2018/11/2	2610.73	2651.08	2610.73	2649.81
```

**M1数据 (M1.txt):**
```
2018/11/1-9:31	2603.50	2605.00	2602.00	2603.50
2018/11/1-9:32	2604.00	2606.00	2603.00	2605.50
```

---

## 计算流程

### 第一步:数据加载

从数据文件中读取:
- 历史日线数据(开高低收)
- 历史分钟数据(按年份存储的CSV文件)
- 当日M1分钟数据

### 第二步:特征值计算

对价格数据进行数字求和取余运算:

#### 计算方法
将价格的每一位数字相加,除以8取余数

#### 示例

```
开盘价: 3324.62
计算: 3+3+2+4+6+2 = 20
余数: 20 ÷ 8 = 2 余 4  → 特征值 = 4

最高价: 3352.08
计算: 3+3+5+2+0+8 = 21
余数: 21 ÷ 8 = 2 余 5  → 特征值 = 5

最低价: 3312.44
计算: 3+3+1+2+4+4 = 17
余数: 17 ÷ 8 = 2 余 1  → 特征值 = 1

收盘价: 3333.02
计算: 3+3+3+3+0+2 = 14
余数: 14 ÷ 8 = 1 余 6  → 特征值 = 6
```

**特殊情况处理:**
- 如果余数为0(整除),则按8处理
- 如果相加结果小于8,则按8处理

**当日特征:** [开:4, 高:5, 低:1, 收:6]

### 第三步:历史数据匹配

根据当日计算的特征值,在历史日线数据中查找匹配的日期。

#### 匹配规则

固定匹配:
- 开盘价特征值(K)
- 收盘价特征值(S)

循环匹配(共16次,去重后15组):
1. 最高价从1-8循环(其他保持不变)
2. 最低价从1-8循环(其他保持不变)

#### 匹配示例

假设当日特征为 [开:4, 高:5, 低:1, 收:6]

**高价循环(低=1,开=4,收=6):**
```
4-1-1-6
4-2-1-6
4-3-1-6
4-4-1-6
4-5-1-6  ← 与当日相同
4-6-1-6
4-7-1-6
4-8-1-6
```

**低价循环(高=5,开=4,收=6):**
```
4-5-1-6  ← 重复,只保留一次
4-5-2-6
4-5-3-6
4-5-4-6
4-5-5-6
4-5-6-6
4-5-7-6
4-5-8-6
```

总计15个独特组合,系统会找出历史上所有匹配这些特征的日期。

### 第四步:高低点识别

对1分钟数据进行高低点标记。

#### 定义

**高点:** 比前一分钟高 且 比后一分钟高
**低点:** 比前一分钟低 且 比后一分钟低

#### 示例

```
时间    价格    标记
9:30   2603    -
9:31   2605    高点 (2605 > 2603 且 2605 > 2604)
9:32   2604    -
9:33   2602    低点 (2602 < 2604 且 2602 < 2603)
9:34   2603    -
```

### 第五步:正反值统计

将当日M1数据与历史匹配日期的M1数据进行高低点对比。

#### 定义

**正(同向):**
- 同一时刻:高点对高点
- 同一时刻:低点对低点

**反(反向):**
- 同一时刻:高点对低点
- 同一时刻:低点对高点

#### 统计示例

```
时间    当日    历史日    结果
9:31    高点    高点     正 +1
9:33    低点    高点     反 +1
9:35    高点    高点     正 +1
9:37    低点    低点     正 +1
...
总计: 正=156, 反=84
```

### 第六步:涨跌震荡判断

以11:30(第120分钟)为分界线,判断走势类型。

#### 判断规则

**涨:**
- 下午最高点 > 上午最高点
- 下午最低点 > 上午最低点

**跌:**
- 下午最高点 < 上午最高点
- 下午最低点 < 上午最低点

**震荡:**
- 除涨、跌之外的所有形态

### 第七步:合格筛选

以当日数据(第二张图)为基准,与历史数据(第一张图)对比。

#### 合格标准

| 当日形态 | 历史形态 | 判定 |
|---------|---------|------|
| 涨 | 涨 | ✓ 合格 |
| 涨 | 跌 | ✗ 不合格 |
| 涨 | 震荡 | ✗ 不合格 |
| 跌 | 跌 | ✓ 合格 |
| 跌 | 涨 | ✗ 不合格 |
| 跌 | 震荡 | ✗ 不合格 |
| 震荡 | 涨/跌/震荡 | ✓ 合格 |

**重要规则:**
- 如果 不合格数量 > 合格数量,直接淘汰该组
- 如果 反向数量 > 正向数量,将图像上下翻转

### 第八步:平移计算

为提高预测精度,对数据进行时间平移,生成多组预测结果。

#### 平移方法

一天交易240分钟,以240分钟为窗口向前滑动:

```
第1组: 2018/11/01 09:31 - 2018/11/01 15:00 (0偏移)
第2组: 2018/10/31 15:00 - 2018/11/01 14:59 (偏移1)
第3组: 2018/10/31 14:59 - 2018/11/01 14:58 (偏移2)
第4组: 2018/10/31 14:58 - 2018/11/01 14:57 (偏移3)
...
```

每组平移都执行完整的计算流程,增加预测选项。

### 第九步:相似度计算与排序

对通过筛选的图组计算相似度,选出最佳匹配。

#### 相似度算法
- 基于欧氏距离
- 考虑涨跌方向一致性
- 考虑关键高低点位置匹配度

**最终输出:** 相似度最高的前N组(默认3组)

### 第十步:结果展示

生成三张图的组合:

```
┌─────────────┐
│  第一张图   │  历史匹配日的分时走势
├─────────────┤
│  第二张图   │  当日(用于匹配的)分时走势
├─────────────┤
│  第三张图   │  第一张图的次日走势(预测参考)
└─────────────┘
```

**图像信息包含:**
- 组号与相似度
- 正反值统计
- 平移偏移量
- 日期标注

---

## 安装与使用

### 环境要求

- Go 1.16+
- 操作系统:Linux/macOS/Windows

### 依赖安装

```bash
go get -u github.com/disintegration/imaging
go get -u github.com/golang/freetype
go get -u gonum.org/v1/plot
```

### 编译

```bash
go build -o stock_predict main.go unit.go
```

### 基本使用

```bash
# 预测指定日期
./stock_predict -day 2019-05-28

# 指定平移范围
./stock_predict -day 2019-05-28 -py 0 -py2 10

# 指定截取长度(最后60分钟)
./stock_predict -day 2019-05-28 -jb 60

# 自定义输出数量
./stock_predict -day 2019-05-28 -x 5
```

---

## 参数说明

### 命令行参数

| 参数 | 类型 | 默认值 | 说明 |
|-----|------|--------|------|
| `-day` | string | 2019-05-28 | 预测日期(格式:YYYY-MM-DD) |
| `-py` | int | 0 | 平移起始值(0-239) |
| `-py2` | int | 2 | 平移结束值(0-239) |
| `-jb` | int | 60 | 截取长度(分钟数,用于局部对比) |
| `-x` | int | 3 | 输出结果数量(前N组) |
| `-ty` | int | 0 | 类型(0:标准 1:扩展 2:对比) |
| `-gd` | int | 200 | 图像高度(像素) |
| `-kd` | int | 600 | 图像宽度(像素) |
| `-xt` | int | 2 | 线条粗细 |
| `-gm` | int | 40 | 每行图像数量 |

### 配置文件

编辑 `config.json` 可修改更多配置项。

---

## 输出说明

### 输出文件

结果保存在 `~/临时结果/` 目录:

```
结果_0.png    第一批结果(包含gm个图组)
结果_1.png    第二批结果
...
```

### 图像解读

每个图组包含:
- 顶部:统计信息(组号、相似度、正反值、偏移量)
- 第一行:历史匹配日分时图
- 第二行:当日数据分时图
- 第三行:预测参考日分时图

**颜色说明:**
- 白色线条:正常走势
- 红色虚线:时间分隔线(30分钟)
- 黑色背景:图像底色

---

## 算法流程图

```
开始
  ↓
[加载数据]
  ├─ 历史日线数据
  ├─ 历史M1数据
  └─ 当日M1数据
  ↓
[计算特征值]
  开、高、低、收 → 余数[1-8]
  ↓
[匹配历史]
  查找15组特征组合
  ↓
[高低点识别]
  标记M1数据的高低点
  ↓
[正反值统计]
  对比当日与历史的高低点
  ↓
[涨跌判断]
  判断走势形态(涨/跌/震荡)
  ↓
[合格筛选]
  过滤不合格组合
  ↓
[平移计算]
  生成多个时间窗口
  ↓
[相似度排序]
  选出最佳匹配组
  ↓
[生成图像]
  输出预测结果
  ↓
结束
```

---

## 注意事项

1. **数据完整性:** 确保历史数据完整,缺失会影响匹配精度
2. **日期格式:** 统一使用 YYYY-MM-DD 格式
3. **交易日检查:** 系统会自动跳过非交易日
4. **内存占用:** 加载20年数据约需2GB内存
5. **计算时间:** 完整计算一天数据约需1-3分钟

---

## 常见问题

### Q: 为什么输出结果为空?
A: 检查:
- 日期是否为交易日
- 数据文件是否完整
- 是否有匹配的历史数据

### Q: 如何提高预测准确度?
A: 可以尝试:
- 增加平移范围(-py2)
- 调整截取长度(-jb)
- 增加输出数量(-x)

### Q: 图像显示异常?
A: 检查:
- 字体文件(FZBSJW.ttf)是否存在
- 图像尺寸参数是否合理

---

## 技术架构

### 核心模块

```
main.go          主程序入口
  ├─ ready()     初始化与数据加载
  ├─ run_py()    单次平移计算
  └─ main()      主流程控制

unit.go          工具函数库
  ├─ get_he()    计算余数特征
  ├─ get_m1()    获取M1数据
  ├─ gd()        高低点识别
  ├─ zd()        涨跌判断
  ├─ osjl()      相似度计算
  └─ get_p()     图像生成
```

### 数据结构

```go
// 单条K线数据
type sed struct {
    dy, tm         string      // 日期、时间
    dk, dg, dd, ds float64     // 开、高、低、收
    g, d           int         // 高低点标记
}

// K线数据集合
type seds struct {
    vec            map[int]*sed  // 分钟数据映射
    z, f           int           // 正、反值统计
    sg, sd, xg, xd float64       // 上午高低、下午高低
}

// 匹配结果
type sds struct {
    dt1, dt2       plotter.XYs  // 图形数据点
    dy, dy_1, dy_2 string        // 日期标识
    zh, fa         int           // 正、反统计
    osjl           float64       // 相似度
    py             int           // 平移量
}
```

---

## 版本历史

- **v4 (当前版本):**
  - 添加截取对比功能
  - 优化相似度算法
  - 支持配置文件

- **v3:**
  - 添加平移计算
  - 支持批量输出

- **v2:**
  - 实现完整算法
  - 支持图像生成

- **v1:**
  - 基础功能原型

---

## 许可证

本项目仅供学习研究使用,不构成投资建议。

---

## 联系方式

如有问题,请参考本文档或查看源代码注释。

---

**最后更新:** 2025-11-11
